<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>V‚ÄëMACH ‚Ä¢ Production Badges</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#8efadb" />

  <!-- Fonts & Favicon -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="icon"
    type="image/png"
    href="https://djuqbvg97u5zb.cloudfront.net/vmachonpr/images/websitelogos/retailer_site_logo88.png"
  />

  <style>

    :root {
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 12px;
      --touch: 52px;
      --safe-bottom: env(safe-area-inset-bottom, 18px);
      --header-h: 208px;
      --page-pad: clamp(18px, 4vw, 48px);
      font-size: 16px;
    }
    [data-theme="dark"] {
      color-scheme: dark;
      --bg: #030611;
      --bg-alt: #050a16;
      --surface: rgba(11, 19, 35, 0.9);
      --surface-strong: #0b1324;
      --surface-soft: rgba(14, 24, 42, 0.78);
      --stroke: rgba(120, 178, 255, 0.18);
      --text: #f3f6ff;
      --muted: #92a2c2;
      --text-muted: rgba(235, 243, 255, 0.72);
      --text-subtle: rgba(235, 243, 255, 0.6);
      --text-soft: rgba(243, 246, 255, 0.68);
      --text-placeholder: rgba(235, 243, 255, 0.45);
      --text-faint: rgba(235, 243, 255, 0.4);
      --ghost-text: rgba(235, 243, 255, 0.85);
      --border-subtle: rgba(255, 255, 255, 0.18);
      --control-bg: rgba(255, 255, 255, 0.06);
      --control-border: rgba(255, 255, 255, 0.08);
      --ghost-bg: rgba(255, 255, 255, 0.04);
      --ghost-border: rgba(255, 255, 255, 0.25);
      --ghost-hover-bg: rgba(142, 250, 219, 0.12);
      --ghost-hover-border: rgba(142, 250, 219, 0.65);
      --ghost-hover-text: var(--accent);
      --ghost-active-bg: rgba(142, 250, 219, 0.18);
      --ghost-active-border: rgba(142, 250, 219, 0.75);
      --ghost-active-text: var(--accent);
      --chip-active-border: rgba(142, 250, 219, 0.55);
      --note-bg: rgba(13, 24, 42, 0.85);
      --note-border: rgba(255, 255, 255, 0.12);
      --note-text: rgba(235, 243, 255, 0.78);
      --accent: #8efadb;
      --accent-2: #94a6ff;
      --accent-soft: rgba(142, 250, 219, 0.22);
      --warn: #f6c945;
      --danger: #ff5774;
      --ok: #4fe5ad;
      --btn-bg: rgba(10, 20, 36, 0.82);
      --btn-border: rgba(255, 255, 255, 0.08);
      --btn-text: #f3f6ff;
      --btn-pause-bg: rgba(246, 201, 69, 0.24);
      --btn-pause-border: rgba(246, 201, 69, 0.45);
      --btn-pause-text: #1f1908;
      --btn-done-bg: rgba(79, 229, 173, 0.25);
      --btn-done-border: rgba(79, 229, 173, 0.45);
      --btn-done-text: #012c1b;
      --btn-del-bg: rgba(255, 87, 116, 0.28);
      --btn-del-border: rgba(255, 87, 116, 0.45);
      --btn-del-text: #ffeef2;
      --input-bg: rgba(7, 14, 26, 0.85);
      --input-text: #f3f6ff;
      --input-border: rgba(255, 255, 255, 0.12);
      --input-focus-border: rgba(111, 255, 233, 0.45);
      --input-focus-ring: rgba(111, 255, 233, 0.15);
      --brand-gradient: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      --shadow-lg: 0 24px 46px rgba(4, 8, 20, 0.55);
      --shadow-md: 0 14px 32px rgba(5, 10, 25, 0.45);
      --header-bg: linear-gradient(185deg, rgba(7, 12, 24, 0.94) 0%, rgba(7, 12, 24, 0.66) 100%);
      --header-border: rgba(255, 255, 255, 0.08);
      --header-shadow: 0 24px 46px rgba(4, 8, 20, 0.55);
      --header-sticky-shadow: 0 18px 32px rgba(4, 8, 20, 0.55);
      --header-overlay: linear-gradient(185deg, rgba(7, 12, 24, 0.96), rgba(7, 12, 24, 0.7));
      --header-icon-bg: linear-gradient(145deg, rgba(255, 255, 255, 0.14) 0%, rgba(255, 255, 255, 0.02) 100%),
        var(--surface);
      --header-icon-border: rgba(255, 255, 255, 0.12);
      --header-icon-shadow: 0 10px 26px rgba(6, 12, 24, 0.45);
      --chip-bg: rgba(255, 255, 255, 0.06);
      --chip-border: rgba(255, 255, 255, 0.08);
      --chip-active-shadow: 0 8px 18px rgba(8, 32, 26, 0.4);
      --field-bg: rgba(15, 24, 38, 0.9);
      --field-border: rgba(255, 255, 255, 0.08);
      --field-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      --insight-bg: linear-gradient(165deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0)),
        var(--surface);
      --insight-border: rgba(255, 255, 255, 0.12);
      --insight-card-bg: linear-gradient(165deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 75%),
        var(--surface-soft);
      --insight-card-border: rgba(255, 255, 255, 0.08);
      --insight-card-shadow: 0 18px 32px rgba(4, 10, 24, 0.35);
      --insight-card-highlight: radial-gradient(circle at top right, rgba(255, 255, 255, 0.12), transparent 60%);
      --card-bg: linear-gradient(155deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0) 80%), var(--surface);
      --card-border: rgba(255, 255, 255, 0.08);
      --badge-bg: rgba(255, 255, 255, 0.06);
      --badge-border: rgba(255, 255, 255, 0.1);
      --badge-text: var(--ghost-text);
      --badge-pause-bg: rgba(246, 201, 69, 0.22);
      --badge-pause-border: rgba(246, 201, 69, 0.55);
      --badge-pause-text: #1e1b09;
      --badge-done-bg: rgba(79, 229, 173, 0.25);
      --badge-done-border: rgba(79, 229, 173, 0.55);
      --badge-done-text: #022b1a;
      --insight-progress-bg: rgba(255, 255, 255, 0.08);
    }
    [data-theme="light"] {
      color-scheme: light;
      --bg: #f4f7fb;
      --bg-alt: #ffffff;
      --surface: rgba(255, 255, 255, 0.92);
      --surface-strong: #ffffff;
      --surface-soft: rgba(241, 245, 255, 0.78);
      --stroke: rgba(118, 140, 198, 0.18);
      --text: #1e293b;
      --muted: #5f6c80;
      --text-muted: #52607a;
      --text-subtle: #6a7890;
      --text-soft: #64748b;
      --text-placeholder: #94a3b8;
      --text-faint: #9aa5b5;
      --ghost-text: #1f3d78;
      --border-subtle: rgba(30, 41, 59, 0.18);
      --control-bg: rgba(47, 123, 255, 0.12);
      --control-border: rgba(47, 123, 255, 0.26);
      --ghost-bg: rgba(47, 123, 255, 0.1);
      --ghost-border: rgba(47, 123, 255, 0.32);
      --ghost-hover-bg: rgba(47, 123, 255, 0.16);
      --ghost-hover-border: rgba(47, 123, 255, 0.5);
      --ghost-hover-text: var(--accent);
      --ghost-active-bg: rgba(47, 123, 255, 0.18);
      --ghost-active-border: rgba(47, 123, 255, 0.55);
      --ghost-active-text: var(--accent);
      --chip-active-border: rgba(47, 123, 255, 0.4);
      --note-bg: rgba(47, 123, 255, 0.1);
      --note-border: rgba(47, 123, 255, 0.26);
      --note-text: #1f3d78;
      --accent: #2f7bff;
      --accent-2: #2ac6a8;
      --accent-soft: rgba(47, 123, 255, 0.16);
      --warn: #d9941a;
      --danger: #d64562;
      --ok: #2eaf70;
      --btn-bg: #2f7bff;
      --btn-border: #2260d1;
      --btn-text: #ffffff;
      --btn-pause-bg: #f6c945;
      --btn-pause-border: #c58f06;
      --btn-pause-text: #3f2d00;
      --btn-done-bg: #2eaf70;
      --btn-done-border: #1f7a4d;
      --btn-done-text: #ffffff;
      --btn-del-bg: #d64562;
      --btn-del-border: #a62f47;
      --btn-del-text: #ffffff;
      --input-bg: #ffffff;
      --input-text: #1e293b;
      --input-border: rgba(28, 51, 101, 0.2);
      --input-focus-border: rgba(47, 123, 255, 0.45);
      --input-focus-ring: rgba(47, 123, 255, 0.15);
      --brand-gradient: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      --shadow-lg: 0 24px 40px rgba(15, 35, 95, 0.12);
      --shadow-md: 0 14px 28px rgba(18, 36, 90, 0.1);
      --header-bg: linear-gradient(185deg, rgba(255, 255, 255, 0.95) 0%, rgba(232, 239, 255, 0.88) 100%);
      --header-border: rgba(30, 41, 59, 0.12);
      --header-shadow: 0 24px 36px rgba(15, 35, 95, 0.15);
      --header-sticky-shadow: 0 18px 24px rgba(15, 35, 95, 0.14);
      --header-overlay: linear-gradient(185deg, rgba(255, 255, 255, 0.96), rgba(232, 239, 255, 0.78));
      --header-icon-bg: linear-gradient(145deg, rgba(255, 255, 255, 0.96) 0%, rgba(232, 239, 255, 0.8) 100%),
        var(--surface);
      --header-icon-border: rgba(30, 41, 59, 0.16);
      --header-icon-shadow: 0 12px 24px rgba(15, 35, 95, 0.15);
      --chip-bg: rgba(47, 123, 255, 0.12);
      --chip-border: rgba(47, 123, 255, 0.26);
      --chip-active-shadow: 0 8px 18px rgba(47, 123, 255, 0.3);
      --field-bg: #ffffff;
      --field-border: rgba(28, 51, 101, 0.2);
      --field-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      --insight-bg: linear-gradient(165deg, rgba(47, 123, 255, 0.14), rgba(42, 198, 168, 0.06)),
        var(--surface);
      --insight-border: rgba(30, 41, 59, 0.12);
      --insight-card-bg: linear-gradient(165deg, rgba(47, 123, 255, 0.16) 0%, rgba(42, 198, 168, 0.08) 75%),
        var(--surface-soft);
      --insight-card-border: rgba(47, 123, 255, 0.2);
      --insight-card-shadow: 0 18px 32px rgba(47, 123, 255, 0.18);
      --insight-card-highlight: radial-gradient(circle at top right, rgba(47, 123, 255, 0.22), transparent 60%);
      --card-bg: linear-gradient(155deg, rgba(47, 123, 255, 0.12) 0%, rgba(42, 198, 168, 0.08) 80%), var(--surface);
      --card-border: rgba(30, 41, 59, 0.12);
      --badge-bg: rgba(47, 123, 255, 0.12);
      --badge-border: rgba(47, 123, 255, 0.26);
      --badge-text: #1f3d78;
      --badge-pause-bg: rgba(246, 201, 69, 0.26);
      --badge-pause-border: rgba(197, 143, 6, 0.55);
      --badge-pause-text: #3f2d00;
      --badge-done-bg: rgba(46, 175, 112, 0.22);
      --badge-done-border: rgba(31, 122, 77, 0.45);
      --badge-done-text: #0d4128;
      --insight-progress-bg: rgba(30, 41, 59, 0.12);
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      background:
        radial-gradient(120% 130% at 20% -10%, rgba(148, 166, 255, 0.24) 0%, transparent 55%),
        radial-gradient(120% 160% at 80% 0%, rgba(142, 250, 219, 0.18) 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
      color: var(--text);
      padding: var(--page-pad);
    }
    .page-grid {
      width: min(1280px, 100%);
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      grid-template-areas:
        "header"
        "list";
      gap: clamp(18px, 3.5vw, 36px);
      align-items: start;
    }
    .page-main {
      grid-area: list;
      display: grid;
      gap: clamp(18px, 3vw, 28px);
      padding: clamp(22px, 3.5vw, 32px);
      border-radius: var(--radius-lg);
      background:
        linear-gradient(160deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0) 85%),
        var(--surface);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: var(--shadow-lg);
      min-height: 0;
      padding-bottom: calc(140px + var(--safe-bottom));
    }

    @media (max-width: 720px) {
      :root {
        --page-pad: 20px;
        --radius-lg: 20px;
        --radius-md: 16px;
        --radius-sm: 12px;
      }
      body {
        padding: 0;
      }
      .page-grid {
        width: 100%;
        margin: 0;
        padding: 0;
        gap: 0;
      }
      header.page-header {
        position: sticky;
        top: 0;
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        box-shadow: var(--header-sticky-shadow);
      }
      header.page-header::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: var(--header-overlay);
        z-index: -1;
      }
      .topbar {
        padding-top: calc(env(safe-area-inset-top, 0) + clamp(18px, 6vw, 28px));
        padding-bottom: clamp(16px, 5vw, 24px);
      }
      .chip-row {
        margin: 0 calc(-1 * var(--page-pad));
        padding: 0 var(--page-pad) 4px;
      }
      .chip-row .chip {
        padding: 10px 18px;
        font-size: 0.85rem;
      }
      .utility {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      .search input {
        min-height: 46px;
        font-size: 1rem;
      }
      .sort-select {
        justify-content: space-between;
        min-height: 46px;
        font-size: 0.95rem;
      }
      .page-main {
        border-radius: 0;
        margin: 0;
        padding: 22px var(--page-pad) calc(140px + var(--safe-bottom));
      }
      #list {
        gap: 16px;
      }
      .card {
        border-radius: var(--radius-md);
        padding: 20px 18px 18px;
      }
      #insights {
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        max-height: none;
        border-radius: 0;
        padding: calc(env(safe-area-inset-top, 0) + 24px) var(--page-pad) calc(28px + var(--safe-bottom));
        transform: translateY(8%) scale(0.94);
      }
      #insights.open {
        transform: translateY(0) scale(1);
      }
      .insights__row {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      .insights__actions {
        justify-content: center;
      }
      .export {
        margin: 22px 0 8px;
      }
      .fab {
        width: 64px;
        height: 64px;
        font-size: 30px;
        right: var(--page-pad);
        bottom: calc(var(--page-pad) + var(--safe-bottom));
      }
    }

    header {
      grid-area: header;
      position: relative;
      inset: auto;
      z-index: 40;
      align-self: start;
      backdrop-filter: blur(22px) saturate(150%);
      background: var(--header-bg);
      border: 1px solid var(--header-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--header-shadow);
    }
    .topbar {
      margin: 0;
      padding: clamp(18px, 3vw, 28px) clamp(18px, 3vw, 28px) clamp(14px, 2.5vw, 22px);
      display: grid;
      gap: clamp(12px, 2vw, 18px);
    }
    .topbar__head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .brand img {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
    }
    .brand__text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.1;
    }
    .brand__text strong {
      font-size: 1.05rem;
      letter-spacing: 0.2px;
    }
    .brand__text span {
      font-size: 0.75rem;
      color: var(--text-subtle);
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }
    .topbar__actions {
      display: flex;
      gap: 8px;
    }
    button {
      font-family: inherit;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      background: none;
      color: inherit;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .icon-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: var(--text);
      background: var(--header-icon-bg);
      border: 1px solid var(--header-icon-border);
      box-shadow: var(--header-icon-shadow);
    }
    .icon-btn:active {
      transform: translateY(1px) scale(0.98);
    }
    .chip-row {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 2px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .chip-row::-webkit-scrollbar {
      display: none;
    }
    .chip-row .chip {
      flex: 0 0 auto;
      padding: 8px 18px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.1px;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      white-space: nowrap;
    }
    .chip-row .chip.active {
      background: var(--accent-soft);
      border-color: var(--chip-active-border);
      color: var(--text);
      box-shadow: var(--chip-active-shadow);
    }
    .utility {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search {
      position: relative;
      flex: 1;
    }
    .search input {
      width: 100%;
      padding: 12px 44px 12px 16px;
      border-radius: 999px;
      border: 1px solid var(--field-border);
      background: var(--field-bg);
      color: var(--text);
      font-size: 0.95rem;
      box-shadow: var(--field-shadow);
    }
    .search input::placeholder {
      color: var(--text-placeholder);
    }
    .search .ico {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.05rem;
      opacity: 0.7;
    }
    .sort-select {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--control-bg);
      border: 1px solid var(--control-border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      font-weight: 600;
    }
    .sort-select select {
      background: transparent;
      border: none;
      color: inherit;
      font-weight: 600;
      font-size: 0.95rem;
      appearance: none;
      padding-right: 12px;
    }
    .sort-select select:focus {
      outline: none;
    }

    #insights {
      grid-area: insights;
      position: fixed;
      top: calc(var(--page-pad) + 72px);
      left: 50%;
      width: min(420px, calc(100% - 2 * var(--page-pad)));
      padding: 20px clamp(18px, 3vw, 24px) 24px;
      border-radius: var(--radius-lg);
      background: var(--insight-bg);
      border: 1px solid var(--insight-border);
      box-shadow: var(--shadow-lg);
      transform-origin: top center;
      transform: translate(-50%, -6%) scale(0.92);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.22s ease, transform 0.22s ease;
      z-index: 70;
      max-height: calc(100vh - 2 * var(--page-pad));
      overflow: auto;
    }
    #insights.open {
      opacity: 1;
      transform: translate(-50%, 0) scale(1);
      pointer-events: auto;
    }
    .insights__head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }
    .insights__head strong {
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }
    .insights__row {
      display: grid;
      gap: clamp(12px, 2vw, 18px);
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
    .insight-card {
      padding: 14px 16px 16px;
      border-radius: var(--radius-md);
      background: var(--insight-card-bg);
      border: 1px solid var(--insight-card-border);
      box-shadow: var(--insight-card-shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }
    .insight-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--insight-card-highlight);
      opacity: 0.4;
      pointer-events: none;
    }
    .insight-card span {
      font-size: 0.75rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    .insight-card strong {
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 6px 18px rgba(142, 250, 219, 0.35);
    }
    .insight-card small {
      font-size: 0.8rem;
      color: var(--text-subtle);
      line-height: 1.3;
    }
    .insight-card--wide {
      grid-column: span 2;
    }
    @media (max-width: 520px) {
      .insight-card--wide {
        grid-column: span 1;
      }
    }
    .insight-progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: var(--insight-progress-bg);
      overflow: hidden;
      position: relative;
    }
    .insight-progress__bar {
      position: absolute;
      inset: 0;
      width: 0;
      background: var(--brand-gradient);
      border-radius: inherit;
      box-shadow: 0 4px 12px rgba(142, 250, 219, 0.35);
      transition: width 0.25s ease;
    }
    .insights__actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .ghost-small {
      background: var(--ghost-bg);
      border: 1px dashed var(--ghost-border);
      color: var(--ghost-text);
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      letter-spacing: 0.2px;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }
    .ghost-small:hover {
      background: var(--ghost-hover-bg);
      border-color: var(--ghost-hover-border);
      color: var(--ghost-hover-text);
    }

    #list {
      margin-top: 0;
      display: grid;
      gap: clamp(12px, 2vw, 18px);
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-md);
      animation: fade 0.25s ease;
      backdrop-filter: blur(2px);
    }
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    .row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .handle {
      cursor: grab;
      user-select: none;
      color: var(--text-faint);
      font-size: 1.2rem;
    }
    .title {
      flex: 1;
      min-width: 0;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.15px;
    }
    .title span {
      display: block;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      background: var(--badge-bg);
      border: 1px solid var(--badge-border);
      color: var(--badge-text);
    }
    .badge[data-s="pause"] {
      background: var(--badge-pause-bg);
      border-color: var(--badge-pause-border);
      color: var(--badge-pause-text);
    }
    .badge[data-s="done"] {
      background: var(--badge-done-bg);
      border-color: var(--badge-done-border);
      color: var(--badge-done-text);
    }
    .meta {
      margin-top: 10px;
      color: var(--text-muted);
      font-size: 0.82rem;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      word-break: break-word;
    }
    .meta b {
      color: var(--text);
    }
    .note {
      margin-top: 10px;
      font-size: 0.84rem;
      color: var(--note-text);
      background: var(--note-bg);
      border: 1px dashed var(--note-border);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
    }
    .actions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }
    .btn {
      min-height: var(--touch);
      border-radius: var(--radius-sm);
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(5, 12, 26, 0.35);
    }
    .btn[data-a="pause"] {
      background: var(--btn-pause-bg);
      color: var(--btn-pause-text);
      border-color: var(--btn-pause-border);
    }
    .btn[data-a="done"] {
      background: var(--btn-done-bg);
      color: var(--btn-done-text);
      border-color: var(--btn-done-border);
    }
    .btn[data-a="del"] {
      background: var(--btn-del-bg);
      color: var(--btn-del-text);
      border-color: var(--btn-del-border);
    }
    .awaiting-long {
      border-color: rgba(148, 166, 255, 0.55);
      box-shadow: 0 0 0 1px rgba(148, 166, 255, 0.45) inset, var(--shadow-md);
    }

    .empty-state {
      margin-top: 30px;
      padding: 26px;
      border-radius: var(--radius-lg);
      border: 1px dashed var(--border-subtle);
      background:
        linear-gradient(160deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0));
      text-align: center;
      color: var(--text-muted);
      line-height: 1.5;
      box-shadow: 0 16px 28px rgba(6, 12, 26, 0.35);
    }
    .empty-state strong {
      display: block;
      font-size: 1.05rem;
      margin-bottom: 6px;
      color: var(--text);
    }

    .export {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 18px 0;
    }
    .pill {
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
      color: var(--text);
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: 0 12px 26px rgba(5, 10, 24, 0.35);
    }

    .fab {
      position: fixed;
      right: max(20px, var(--page-pad));
      bottom: calc(var(--page-pad) + var(--safe-bottom));
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: var(--brand-gradient);
      color: #07121f;
      border: none;
      box-shadow: 0 26px 48px rgba(8, 16, 30, 0.6);
      font-size: 34px;
    }
    .fab:active {
      transform: scale(0.96);
    }

    .sheet,
    .settings {
      position: fixed;
      left: 0;
      right: 0;
      bottom: -100%;
      background: var(--surface-strong);
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 -28px 40px rgba(0, 0, 0, 0.55);
      padding: 18px 18px calc(28px + var(--safe-bottom));
      transition: bottom 0.28s ease;
      z-index: 80;
      max-width: 520px;
      margin: 0 auto;
    }
    .sheet.open,
    .settings.open {
      bottom: 0;
    }
    .sheet h3,
    .settings h3 {
      margin: 4px 4px 14px;
      font-size: 1.05rem;
    }
    .f {
      display: grid;
      gap: 10px;
    }
    .f input,
    .f select,
    .f textarea {
      width: 100%;
      min-height: 52px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--input-text);
      padding: 12px 14px;
      font-size: 1rem;
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    .f textarea {
      min-height: 90px;
      resize: vertical;
    }
    .f input:focus,
    .f select:focus,
    .f textarea:focus {
      border-color: var(--input-focus-border);
      box-shadow: 0 0 0 2px var(--input-focus-ring);
    }
    .row2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .cta {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .ghost {
      background: var(--ghost-bg);
      border: 1px dashed var(--ghost-border);
      color: var(--ghost-text);
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }
    .ghost:hover {
      background: var(--ghost-hover-bg);
      border-color: var(--ghost-hover-border);
      color: var(--ghost-hover-text);
    }
    .theme-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .theme-grid .ghost-small.active {
      background: var(--ghost-active-bg);
      border-color: var(--ghost-active-border);
      color: var(--ghost-active-text);
    }

    body.dense .card {
      padding: 12px 14px;
    }
    body.dense .btn {
      min-height: 44px;
    }
    body.dense .actions {
      gap: 8px;
    }
    body.dense .search input {
      padding: 10px 40px 10px 14px;
    }

    .confetti {
      position: fixed;
      pointer-events: none;
      inset: 0;
      z-index: 90;
    }

    @media (min-width: 600px) {
      .sheet,
      .settings {
        border-radius: 26px;
      }
    }

    @media (min-width: 768px) {
      .page-grid {
        grid-template-columns: minmax(0, 1.1fr) minmax(280px, 0.9fr);
        grid-template-areas:
          "header header"
          "list insights";
      }
      header {
        position: sticky;
        top: var(--page-pad);
      }
      #insights {
        position: sticky;
        top: var(--page-pad);
        left: auto;
        width: 100%;
        max-height: none;
        transform: none;
        opacity: 1;
        pointer-events: auto;
        box-shadow: var(--shadow-lg);
        overflow: visible;
        align-self: start;
      }
      #insights.open {
        transform: none;
      }
      .insights__actions {
        justify-content: flex-start;
      }
      #insightToggle {
        display: none;
      }
      #closeInsights {
        display: none;
      }
      .page-main {
        padding-bottom: clamp(160px, 18vh, 220px);
      }
      #list {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    @media (min-width: 1280px) {
      .page-grid {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(320px, 0.85fr);
        grid-template-areas:
          "header header insights"
          "list list insights";
      }
      .insights__row {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      .insight-card--wide {
        grid-column: span 2;
      }
      #list {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
    }

  </style>
</head>
<body>
  <div class="page-grid">
    <header class="page-header">
    <div class="topbar">
      <div class="topbar__head">
        <div class="brand">
          <img
            src="https://djuqbvg97u5zb.cloudfront.net/vmachonpr/images/websitelogos/retailer_site_logo88.png"
            alt="V‚ÄëMACH"
          />
          <div class="brand__text">
            <strong>Production badges</strong>
            <span>V‚ÄëMACH</span>
          </div>
        </div>
        <div class="topbar__actions">
          <button
            id="insightToggle"
            class="icon-btn"
            type="button"
            aria-expanded="false"
            aria-controls="insights"
            title="Afficher les compteurs"
          >
            üìä
          </button>
          <button id="settingsBtn" class="icon-btn" type="button" title="R√©glages">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="chip-row" id="filters">
        <button class="chip active" data-f="all">Toutes</button>
        <button class="chip" data-f="wait">En attente</button>
        <button class="chip" data-f="pause">En pause</button>
        <button class="chip" data-f="done">Termin√©es</button>
      </div>
      <div class="utility">
        <div class="search">
          <input
            id="q"
            type="search"
            placeholder="Recherche rapide (client, badge, format‚Ä¶)"
          />
          <span class="ico">üîé</span>
        </div>
        <label class="sort-select" for="sortBy">
          <span>‚áÖ</span>
          <select id="sortBy" title="Trier les commandes">
            <option value="recent">R√©cent ‚Üí ancien</option>
            <option value="oldest">Ancien ‚Üí r√©cent</option>
            <option value="qty">Quantit√©</option>
            <option value="client">Client A ‚Üí Z</option>
            <option value="status">Statut</option>
          </select>
        </label>
      </div>
    </div>
    </header>

    <aside id="insights" class="insights-panel" aria-hidden="true">
      <div class="insights__head">
        <strong>Compteurs</strong>
        <button class="ghost-small" id="closeInsights" type="button" title="Fermer les compteurs">‚úï</button>
      </div>
      <div class="insights__row">
        <div class="insight-card">
          <span>Badges fabriqu√©s</span>
          <strong id="insightBadges">0</strong>
          <small>Depuis la derni√®re remise √† z√©ro</small>
        </div>
        <div class="insight-card">
          <span>Total commandes</span>
          <strong id="insightOrders">0</strong>
          <small>Commandes enregistr√©es</small>
        </div>
        <div class="insight-card">
          <span>En cours</span>
          <strong id="insightWaiting">0</strong>
          <small>Commandes actives</small>
        </div>
        <div class="insight-card">
          <span>En pause</span>
          <strong id="insightPaused">0</strong>
          <small>Temporis√©es</small>
        </div>
        <div class="insight-card insight-card--wide">
          <span>Dur√©e moyenne (termin√©es)</span>
          <strong id="insightAvg">‚Äî</strong>
          <small id="insightAvgDetail">Aucune commande termin√©e</small>
        </div>
        <div class="insight-card insight-card--wide">
          <span>Temps actif cumul√©</span>
          <strong id="insightActive">‚Äî</strong>
          <div class="insight-progress" aria-hidden="true">
            <div class="insight-progress__bar" id="insightCompletionBar"></div>
          </div>
          <small>
            <b id="insightDoneCount">0</b> termin√©es ‚Ä¢ <span id="insightCompletionLabel">0%</span> de progression
          </small>
        </div>
      </div>
      <div class="insights__actions">
        <button class="ghost-small" id="resetInsights" type="button" title="R√©initialiser les compteurs">
          R√©initialiser
        </button>
      </div>
    </aside>

    <main class="page-main">
      <div id="emptyState" class="empty-state" hidden>
        <strong>Aucune commande</strong>
        Ajoutez votre premi√®re commande pour d√©marrer la production.
      </div>
      <div id="list"></div>

      <div class="export">
        <button class="pill" id="exportCsv">Export CSV</button>
        <button class="pill" id="exportEmail">Export E‚Äëmail</button>
      </div>
    </main>
  </div>

  <button class="fab" id="fab" title="Ajouter">Ôºã</button>
  <canvas class="confetti" id="confetti" width="0" height="0" hidden></canvas>

  <!-- Add/Edit Sheet -->
  <div class="sheet" id="sheet" aria-hidden="true">
    <h3 id="sheetTitle">Nouvelle commande</h3>
    <form class="f" id="orderForm">
      <label class="sr-only" for="fClient">Client *</label>
      <input id="fClient" name="fClient" placeholder="Client *" required />
      <label class="sr-only" for="fName">Nom du badge *</label>
      <input id="fName" name="fName" placeholder="Nom du badge *" required />
      <div class="row2">
        <div>
          <label class="sr-only" for="fQty">Quantit√© *</label>
          <input
            id="fQty"
            name="fQty"
            type="number"
            min="1"
            placeholder="Quantit√© *"
            required
          />
        </div>
        <div>
          <label class="sr-only" for="fDiam">Diam√®tre / format *</label>
          <select id="fDiam" name="fDiam" required>
            <option value="">Diam√®tre / format *</option>
            <option>28 mm</option>
            <option>38 mm</option>
            <option>45 mm</option>
            <option>58 mm</option>
            <option>89 mm</option>
            <option>Rect. 80 √ó 50 mm</option>
          </select>
        </div>
      </div>
      <div class="row2">
        <div>
          <label class="sr-only" for="fFinish">Finition *</label>
          <select id="fFinish" name="fFinish" required>
            <option value="">Finition *</option>
            <option>Mat</option>
            <option>Brillant</option>
          </select>
        </div>
        <div>
          <label class="sr-only" for="fType">Attache *</label>
          <select id="fType" name="fType" required>
            <option value="">Attache *</option>
            <option>√âpingle</option>
            <option>Aimant d√©coratif</option>
            <option>Magn√©tique textile</option>
            <option>Miroir</option>
            <option>D√©capsuleur magnet</option>
          </select>
        </div>
      </div>
      <div class="row2">
        <div>
          <label class="sr-only" for="fCarton">Carton *</label>
          <select id="fCarton" name="fCarton" required>
            <option value="">Carton *</option>
            <option>Bo√Æte A11</option>
            <option>Bo√Æte A12</option>
            <option>Bo√Æte A14</option>
            <option>Petite bo√Æte</option>
          </select>
        </div>
        <div>
          <label class="sr-only" for="fStatus">Statut</label>
          <select id="fStatus" name="fStatus">
            <option value="wait">En attente</option>
            <option value="pause">En pause</option>
            <option value="done">Termin√©e</option>
          </select>
        </div>
      </div>
      <label class="sr-only" for="fNote">Note (optionnel)</label>
      <textarea id="fNote" name="fNote" placeholder="Note (optionnel)"></textarea>
      <div class="cta">
        <button class="btn ghost" id="cancelBtn" type="button">Annuler</button>
        <button
          class="btn"
          id="saveBtn"
          style="background: var(--brand-gradient); color: #111; border: 0"
          type="submit"
        >
          Enregistrer
        </button>
      </div>
    </form>
  </div>

  <!-- Settings sheet -->
  <div class="settings" id="settings" aria-hidden="true">
    <h3>R√©glages</h3>
    <div class="f">
      <label class="ghost"
        ><input
          type="checkbox"
          id="optDur"
          style="transform: scale(1.2); margin-right: 8px; vertical-align: middle"
        />
        Inclure la dur√©e dans l'export e‚Äëmail</label
      >
      <label class="ghost"
        ><input
          type="checkbox"
          id="optHaptic"
          style="transform: scale(1.2); margin-right: 8px; vertical-align: middle"
          checked
        />
        Vibrations (retour haptique)</label
      >
      <label class="ghost"
        ><input
          type="checkbox"
          id="optDense"
          style="transform: scale(1.2); margin-right: 8px; vertical-align: middle"
        />
        Mode compact (dense)</label
      >

      <h4 style="margin: 8px 2px">Th√®me</h4>
      <div class="theme-grid" id="themes">
        <button class="ghost-small" data-theme="light" title="Light">Light</button>
        <button class="ghost-small" data-theme="dark" title="Dark">Dark</button>
      </div>

      <div class="cta">
        <button class="btn ghost" id="closeSettings">Fermer</button>
        <button class="btn" id="clearAll" style="background: var(--danger); color: #fff; border: 0">
          Tout effacer
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    /* ====== State & Utils ====== */
    const K = "vmach_badges_v1";
    const P = "vmach_prefs_v1";
    const THEME = "vmach_theme";
    const STATS_BASE = "vmach_stats_baseline_v1";
    const DEFAULT_THEME = "dark";

    function isValidTheme(value) {
      return value === "light" || value === "dark";
    }

    function resolveTheme(value) {
      return isValidTheme(value) ? value : DEFAULT_THEME;
    }

    let items = load();
    let statsBaseline = loadStatsBaseline();
    let lastStats = {
      produced: 0,
      totalOrders: 0,
      waiting: 0,
      paused: 0,
      avgDurationSec: 0,
      activeSec: 0,
      completion: 0,
      doneCount: 0,
    };
    let filter = "all",
      search = "";
    let sortBy = localStorage.getItem("vmach_sort") || "recent";
    let editId = null;
    let liveTimer = null; // global unique (fix redeclaration)

    items = items.map(enrichItemState);

    const $ = (sel) => document.querySelector(sel);
    const listEl = $("#list");

    const emptyStateEl = $("#emptyState");


    let sortableInstance = null;
    let swipeStartX = 0;
    let swipeStartY = 0;
    let swipeIsHorizontal = false;
    let swipeMoving = false;
    let swipeCard = null;

    const DB_NAME = "vmach_badges_db";
    const DB_STORE = "state";
    const DB_VERSION = 1;
    let dbPromise = null;

    function load() {
      try {
        const d = JSON.parse(localStorage.getItem(K));
        return Array.isArray(d) ? d : [];
      } catch {
        return [];
      }
    }
    function save() {
      localStorage.setItem(K, JSON.stringify(items));
      saveToIndexedDB(items);

    }

    function loadStatsBaseline() {
      try {
        const raw = JSON.parse(localStorage.getItem(STATS_BASE) || "{}");
        if (raw && typeof raw === "object") {
          return {
            produced: Number(raw.produced) || 0,
            totalOrders: Number(raw.totalOrders) || 0,
          };
        }
      } catch (err) {
        console.warn("Impossible de lire le point de remise √† z√©ro des compteurs", err);
      }
      return { produced: 0, totalOrders: 0 };
    }
    function persistStatsBaseline() {
      try {
        localStorage.setItem(STATS_BASE, JSON.stringify(statsBaseline));
      } catch (err) {
        console.warn("Impossible de sauvegarder le point de remise √† z√©ro", err);
      }
    }
    function updateInsightsDisplay() {
      const badges = document.getElementById("insightBadges");
      const orders = document.getElementById("insightOrders");
      if (!badges || !orders) return;
      const base = statsBaseline || { produced: 0, totalOrders: 0 };
      const producedValue = Math.max(0, (lastStats.produced || 0) - (base.produced || 0));
      const totalValue = Math.max(0, (lastStats.totalOrders || 0) - (base.totalOrders || 0));
      badges.textContent = producedValue.toLocaleString("fr-FR");
      orders.textContent = totalValue.toLocaleString("fr-FR");

      const waitingEl = document.getElementById("insightWaiting");
      if (waitingEl) waitingEl.textContent = (lastStats.waiting || 0).toLocaleString("fr-FR");

      const pausedEl = document.getElementById("insightPaused");
      if (pausedEl) pausedEl.textContent = (lastStats.paused || 0).toLocaleString("fr-FR");

      const avgEl = document.getElementById("insightAvg");
      if (avgEl) avgEl.textContent = lastStats.avgDurationSec ? fmtDur(lastStats.avgDurationSec) : "‚Äî";

      const avgDetail = document.getElementById("insightAvgDetail");
      if (avgDetail) {
        const count = lastStats.doneCount || 0;
        avgDetail.textContent = count
          ? `${count.toLocaleString("fr-FR")} commande${count > 1 ? "s" : ""} termin√©e${count > 1 ? "s" : ""}`
          : "Aucune commande termin√©e";
      }

      const activeEl = document.getElementById("insightActive");
      if (activeEl) activeEl.textContent = lastStats.activeSec ? fmtDur(lastStats.activeSec) : "‚Äî";

      const doneCountEl = document.getElementById("insightDoneCount");
      if (doneCountEl) doneCountEl.textContent = (lastStats.doneCount || 0).toLocaleString("fr-FR");

      const completionLabel = document.getElementById("insightCompletionLabel");
      const completionBar = document.getElementById("insightCompletionBar");
      const completionRatio = Math.max(0, Math.min(1, lastStats.completion || 0));
      const completionPercent = Math.round(completionRatio * 100);
      if (completionLabel) completionLabel.textContent = `${completionPercent.toLocaleString("fr-FR")} %`;
      if (completionBar) completionBar.style.width = `${completionPercent}%`;
    }

    async function ensureStoragePersistence() {
      if (!navigator.storage?.persist) return;
      try {
        const persisted = await navigator.storage.persisted();
        if (!persisted) {
          await navigator.storage.persist();
        }
      } catch (err) {
        console.warn("Storage persistence request failed", err);
      }
    }

    function getDb() {
      if (!("indexedDB" in window)) return Promise.resolve(null);
      if (!dbPromise) {
        dbPromise = new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onerror = () => reject(req.error);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(DB_STORE)) {
              db.createObjectStore(DB_STORE, { keyPath: "id" });
            }
          };
          req.onsuccess = () => {
            const db = req.result;
            db.onversionchange = () => {
              db.close();
              dbPromise = null;
            };
            resolve(db);
          };
        }).catch((err) => {
          console.warn("IndexedDB unavailable", err);
          return null;
        });
      }
      return dbPromise;
    }

    async function loadFromIndexedDB() {
      const db = await getDb();
      if (!db) return null;
      return new Promise((resolve) => {
        const tx = db.transaction(DB_STORE, "readonly");
        const store = tx.objectStore(DB_STORE);
        const req = store.get("items");
        req.onsuccess = () => {
          resolve(Array.isArray(req.result?.items) ? req.result.items : null);
        };
        req.onerror = () => resolve(null);
      });
    }

    function saveToIndexedDB(data) {
      getDb()
        .then((db) => {
          if (!db) return;
          const tx = db.transaction(DB_STORE, "readwrite");
          const store = tx.objectStore(DB_STORE);
          store.put({ id: "items", items: data, updatedAt: Date.now() });
          tx.onerror = () => console.warn("IndexedDB write failed", tx.error);
          tx.onabort = () => console.warn("IndexedDB write aborted", tx.error);
        })
        .catch((err) => console.warn("IndexedDB write failed", err));
    }

    async function initPersistentState() {
      await ensureStoragePersistence();
      const persisted = await loadFromIndexedDB();
      if (Array.isArray(persisted)) {
        items = persisted.map(enrichItemState);
        render();
      } else {
        saveToIndexedDB(items);
      }
    }

    async function ensureStoragePersistence() {
      if (!navigator.storage?.persist) return;
      try {
        const persisted = await navigator.storage.persisted();
        if (!persisted) {
          await navigator.storage.persist();
        }
      } catch (err) {
        console.warn("Storage persistence request failed", err);
      }
    }

    function getDb() {
      if (!("indexedDB" in window)) return Promise.resolve(null);
      if (!dbPromise) {
        dbPromise = new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onerror = () => reject(req.error);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(DB_STORE)) {
              db.createObjectStore(DB_STORE, { keyPath: "id" });
            }
          };
          req.onsuccess = () => {
            const db = req.result;
            db.onversionchange = () => {
              db.close();
              dbPromise = null;
            };
            resolve(db);
          };
        }).catch((err) => {
          console.warn("IndexedDB unavailable", err);
          return null;
        });
      }
      return dbPromise;
    }

    async function loadFromIndexedDB() {
      const db = await getDb();
      if (!db) return null;
      return new Promise((resolve) => {
        const tx = db.transaction(DB_STORE, "readonly");
        const store = tx.objectStore(DB_STORE);
        const req = store.get("items");
        req.onsuccess = () => {
          resolve(Array.isArray(req.result?.items) ? req.result.items : null);
        };
        req.onerror = () => resolve(null);
      });
    }

    function saveToIndexedDB(data) {
      getDb()
        .then((db) => {
          if (!db) return;
          const tx = db.transaction(DB_STORE, "readwrite");
          const store = tx.objectStore(DB_STORE);
          store.put({ id: "items", items: data, updatedAt: Date.now() });
          tx.onerror = () => console.warn("IndexedDB write failed", tx.error);
          tx.onabort = () => console.warn("IndexedDB write aborted", tx.error);
        })
        .catch((err) => console.warn("IndexedDB write failed", err));
    }

    async function initPersistentState() {
      await ensureStoragePersistence();
      const persisted = await loadFromIndexedDB();
      if (Array.isArray(persisted)) {
        items = persisted.map(enrichItemState);
        render();
      } else {
        saveToIndexedDB(items);
      }
    }

    function vibrate(ms = 25) {
      if (!$("#optHaptic") || !$("#optHaptic").checked) return;
      if (navigator.vibrate) navigator.vibrate(ms);
    }
    function now() {
      return Date.now();
    }
    function fmtDate(ts) {
      if (!ts) return "‚Äî";
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return "‚Äî";
      return (
        d.toLocaleDateString("fr-FR") +
        " " +
        d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })
      );
    }
    function fmtDur(s) {
      if (!s || s < 1) return "‚Äî";
      const h = Math.floor(s / 3600),
        m = Math.floor((s % 3600) / 60),
        sec = s % 60;
      return (h ? `${h}h ` : "") + (m ? `${m}m ` : "") + (sec ? `${sec}s` : "");
    }
    function statusLabel(s) {
      return s === "done" ? "Termin√©e" : s === "pause" ? "En pause" : "En attente";
    }
    function escapeHtml(t) {
      return String(t).replace(/[&<>\"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
    }

    function ensureTimerFields(item) {
      if (!item || typeof item !== "object") return;
      const active = Number(item.activeMs);
      if (!Number.isFinite(active) || active < 0) {
        const fallback = Number(item.durationSec || 0) * 1000;
        item.activeMs = Number.isFinite(fallback) && fallback > 0 ? fallback : 0;
      } else {
        item.activeMs = active;
      }
      if (typeof item.durationSec !== "number" || Number.isNaN(item.durationSec) || item.durationSec < 0) {
        item.durationSec = item.status === "done" ? Math.floor(item.activeMs / 1000) : 0;
      }
      if (item.status === "wait") {
        item.lastResumeTime = item.lastResumeTime || item.startTime || now();
      } else if (item.status !== "wait") {
        item.lastResumeTime = null;
      }
    }

    function enrichItemState(item) {
      if (!item || typeof item !== "object") return item;
      if (!item.startTime) {
        item.startTime = now();
      }
      ensureTimerFields(item);
      if (item.status === "done") {
        item.durationSec = Math.floor(item.activeMs / 1000);
      }
      return item;
    }

    function getActiveMs(item, ref = now()) {
      if (!item) return 0;
      ensureTimerFields(item);
      if (item.status === "wait" && item.lastResumeTime) {
        return item.activeMs + Math.max(0, ref - item.lastResumeTime);
      }
      return item.activeMs;
    }

    function getEffectiveSeconds(item, ref = now()) {
      return Math.floor(getActiveMs(item, ref) / 1000);
    }

    function transitionStatus(item, nextStatus, ts = now()) {
      if (!item) return;
      ensureTimerFields(item);
      const current = item.status;
      if (current === nextStatus) {
        if (nextStatus === "wait" && !item.lastResumeTime) {
          item.lastResumeTime = ts;
        }
        if (nextStatus === "done") {
          item.durationSec = Math.floor(item.activeMs / 1000);
        }
        return;
      }
      if (nextStatus === "wait") {
        if (current === "wait") return;
        if (current === "done") {
          item.durationSec = Math.floor(item.activeMs / 1000);
        }
        item.status = "wait";
        item.endTime = null;
        item.lastResumeTime = ts;
        return;
      }
      if (nextStatus === "pause") {
        if (current === "wait" && item.lastResumeTime) {
          item.activeMs += Math.max(0, ts - item.lastResumeTime);
        }
        item.status = "pause";
        item.lastResumeTime = null;
        item.endTime = ts;
        item.durationSec = Math.floor(item.activeMs / 1000);
        return;
      }
      if (nextStatus === "done") {
        if (current === "wait" && item.lastResumeTime) {
          item.activeMs += Math.max(0, ts - item.lastResumeTime);
        }
        item.status = "done";
        item.lastResumeTime = null;
        item.endTime = ts;
        item.durationSec = Math.floor(item.activeMs / 1000);
        return;
      }
      item.status = nextStatus;
    }

    function newItem(o) {
      const createdAt = now();
      const start = o.startTime || createdAt;
      const status = o.status || "wait";
      const baseDuration = Number(o.durationSec || 0);
      const activeMs = Number(o.activeMs);
      let endTime = o.endTime || null;
      if (!endTime && (status === "pause" || status === "done")) {
        endTime = createdAt;
      }
      const item = {
        id: String(Date.now()) + Math.random().toString(16).slice(2),
        client: o.client.trim(),
        name: o.name.trim(),
        qty: Number(o.qty),
        diam: o.diam,
        finish: o.finish,
        type: o.type,
        carton: o.carton,
        status,
        note: (o.note || "").trim(),
        startTime: start,
        endTime,
        durationSec: baseDuration > 0 ? baseDuration : 0,
        activeMs: Number.isFinite(activeMs) && activeMs >= 0 ? activeMs : Math.max(0, baseDuration) * 1000,
        lastResumeTime: null,
      };
      if (item.status === "wait") {
        item.lastResumeTime = o.lastResumeTime || start;
      }
      enrichItemState(item);
      if (item.status === "done") {
        item.durationSec = Math.floor(item.activeMs / 1000);
      }
      return item;
    }

    /* ====== Theme & Settings ====== */
    (function initTheme() {
      const stored = localStorage.getItem(THEME);
      const theme = resolveTheme(stored);
      if (stored !== theme) {
        localStorage.setItem(THEME, theme);
      }
      document.documentElement.setAttribute("data-theme", theme);
      markThemeActive(theme);
    })();

    function markThemeActive(t) {
      document.querySelectorAll("#themes [data-theme]").forEach((c) =>
        c.classList.toggle("active", c.dataset.theme === t)
      );
    }
    $("#themes").addEventListener("click", (e) => {
      const t = e.target?.dataset?.theme;
      if (!isValidTheme(t)) return;
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem(THEME, t);
      markThemeActive(t);
      vibrate();
    });

    const prefs = (() => {
      try {
        return Object.assign(
          { emailWithDur: false, haptic: true, dense: false },
          JSON.parse(localStorage.getItem(P) || "{}")
        );
      } catch {
        return { emailWithDur: false, haptic: true, dense: false };
      }
    })();
    $("#optDur").checked = !!prefs.emailWithDur;
    $("#optHaptic").checked = !!prefs.haptic;
    $("#optDense").checked = !!prefs.dense;
    if (prefs.dense) document.body.classList.add("dense");
    $("#optDur").onchange = () => {
      prefs.emailWithDur = $("#optDur").checked;
      localStorage.setItem(P, JSON.stringify(prefs));
    };
    $("#optHaptic").onchange = () => {
      prefs.haptic = $("#optHaptic").checked;
      localStorage.setItem(P, JSON.stringify(prefs));
    };
    $("#optDense").onchange = () => {
      prefs.dense = $("#optDense").checked;
      localStorage.setItem(P, JSON.stringify(prefs));
      document.body.classList.toggle("dense", prefs.dense);
    };

    $("#settingsBtn").onclick = () => {
      $("#settings").classList.add("open");
      vibrate();
      syncHeaderOffset();
    };
    $("#closeSettings").onclick = () => {
      $("#settings").classList.remove("open");
      vibrate();
      syncHeaderOffset();
    };
    $("#clearAll").onclick = () => {
      if (confirm("Supprimer toutes les commandes ?")) {
        items = [];
        save();
        render();
      }
    };

    /* ====== Header offset ====== */
    function syncHeaderOffset() {
      const h = document.querySelector("header")?.offsetHeight || 180;
      document.documentElement.style.setProperty("--header-h", h + "px");
    }
    window.addEventListener("resize", syncHeaderOffset);
    window.addEventListener("orientationchange", syncHeaderOffset);
    document.addEventListener("DOMContentLoaded", syncHeaderOffset);
    setTimeout(syncHeaderOffset, 80);

    const insightPanel = $("#insights");
    const insightToggleBtn = $("#insightToggle");
    const closeInsightsBtn = $("#closeInsights");
    const resetInsightsBtn = $("#resetInsights");
    const insightsAutoOpenMq =
      typeof window.matchMedia === "function" ? window.matchMedia("(min-width: 768px)") : null;

    function setInsightsOpen(open) {
      if (!insightPanel) return;
      const forceOpen = insightsAutoOpenMq?.matches ?? false;
      const nextOpen = forceOpen || !!open;
      insightPanel.classList.toggle("open", nextOpen);
      insightPanel.setAttribute("aria-hidden", String(!nextOpen));
      if (insightToggleBtn) {
        insightToggleBtn.setAttribute("aria-expanded", String(nextOpen));
      }
    }

    if (insightToggleBtn && insightPanel) {
      insightToggleBtn.addEventListener("click", () => {
        if (insightsAutoOpenMq?.matches) return;
        const isOpen = insightPanel.classList.contains("open");
        setInsightsOpen(!isOpen);
        vibrate();
      });
    }
    if (closeInsightsBtn) {
      closeInsightsBtn.addEventListener("click", () => {
        if (insightsAutoOpenMq?.matches) return;
        setInsightsOpen(false);
        vibrate();
      });
    }
    if (resetInsightsBtn) {
      resetInsightsBtn.addEventListener("click", () => {
        statsBaseline = { produced: lastStats.produced, totalOrders: lastStats.totalOrders };
        persistStatsBaseline();
        updateInsightsDisplay();
        vibrate();
      });
    }
    document.addEventListener("keydown", (e) => {
      if (insightsAutoOpenMq?.matches) return;
      if (e.key === "Escape") setInsightsOpen(false);
    });
    document.addEventListener("click", (e) => {
      if (insightsAutoOpenMq?.matches) return;
      if (!insightPanel?.classList.contains("open")) return;
      if (insightPanel.contains(e.target)) return;
      if (insightToggleBtn?.contains(e.target)) return;
      setInsightsOpen(false);
    });

    if (insightsAutoOpenMq) {
      const handleMqChange = (event) => {
        setInsightsOpen(event.matches);
      };
      if (typeof insightsAutoOpenMq.addEventListener === "function") {
        insightsAutoOpenMq.addEventListener("change", handleMqChange);
      } else if (typeof insightsAutoOpenMq.addListener === "function") {
        insightsAutoOpenMq.addListener(handleMqChange);
      }
    }

    setInsightsOpen(insightsAutoOpenMq?.matches ?? false);
    updateInsightsDisplay();

    /* ====== Filters, search, sort ====== */
    [...document.querySelectorAll("#filters button")].forEach((b) => {
      b.onclick = () => {
        [...document.querySelectorAll("#filters button")].forEach((x) =>
          x.classList.remove("active")
        );
        b.classList.add("active");
        filter = b.dataset.f;
        render();
        vibrate();
      };
    });
    $("#q").oninput = (e) => {
      search = e.target.value.trim().toLowerCase();
      render();
    };
    $("#sortBy").value = sortBy;
    $("#sortBy").onchange = (e) => {
      sortBy = e.target.value;
      localStorage.setItem("vmach_sort", sortBy);
      render();
    };

    /* ====== Add/Edit Sheet ====== */
    const sheet = $("#sheet");
    const orderForm = $("#orderForm");
    function openSheet(edit = null) {
      editId = edit ? edit.id : null;
      $("#sheetTitle").textContent = edit ? "Modifier la commande" : "Nouvelle commande";
      if (orderForm) {
        orderForm.reset();
        const fields = orderForm.elements;
        fields.fStatus.value = "wait";
        if (edit) {
          fields.fClient.value = edit.client || "";
          fields.fName.value = edit.name || "";
          fields.fQty.value = edit.qty || "";
          fields.fDiam.value = edit.diam || "";
          fields.fFinish.value = edit.finish || "";
          fields.fType.value = edit.type || "";
          fields.fCarton.value = edit.carton || "";
          fields.fStatus.value = edit.status || "wait";
          fields.fNote.value = edit.note || "";
        }
        setTimeout(() => fields.fClient?.focus(), 100);
      }
      sheet.classList.add("open");
      sheet.setAttribute("aria-hidden", "false");
      syncHeaderOffset();
    }
    function closeSheet() {
      sheet.classList.remove("open");
      sheet.setAttribute("aria-hidden", "true");
      editId = null;
      syncHeaderOffset();
    }

    $("#fab").onclick = () => {
      openSheet();
      vibrate();
    };
    $("#cancelBtn").onclick = () => {
      closeSheet();
      vibrate();
    };

    if (orderForm) {
      orderForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const fields = orderForm.elements;
        const o = {
          client: fields.fClient.value,
          name: fields.fName.value,
          qty: fields.fQty.value,
          diam: fields.fDiam.value,
          finish: fields.fFinish.value,
          type: fields.fType.value,
          carton: fields.fCarton.value,
          status: fields.fStatus.value,
          note: fields.fNote.value,
        };
        if (!o.client || !o.name || !o.qty || !o.diam || !o.finish || !o.type || !o.carton) {
          alert("Merci de remplir tous les champs obligatoires.");
          return;
        }

        if (editId) {
          const ix = items.findIndex((x) => x.id === editId);
          if (ix >= 0) {
            const item = items[ix];
            const prevStatus = item.status;
            const nextStatus = o.status || "wait";
            Object.assign(item, o);
            enrichItemState(item);
            item.status = prevStatus;
            transitionStatus(item, nextStatus, now());
            if (nextStatus === "done" && prevStatus !== "done") {
              confettiBurst();
            }
          }
        } else {
          const created = newItem(o);
          items.unshift(created);
          cardInAnimationNextRender = true;
          transitionStatus(created, created.status, now());
          if (created.status === "done") {
            confettiBurst();
          }
        }
        save();
        render();
        closeSheet();
        vibrate();
      });
    }

    /* ====== Render ====== */
    let cardInAnimationNextRender = false;

    function computeStats() {
      const nowTs = now();
      const doneItems = items.filter((i) => i.status === "done");
      const produced = doneItems.reduce((total, item) => total + (Number(item.qty) || 0), 0);
      const totalOrders = items.length;
      const waiting = items.filter((i) => i.status === "wait").length;
      const paused = items.filter((i) => i.status === "pause").length;
      const doneActiveMs = doneItems.reduce((sum, item) => sum + getActiveMs(item, nowTs), 0);
      const avgDurationSec = doneItems.length ? Math.round(doneActiveMs / doneItems.length / 1000) : 0;
      const activeSec = Math.floor(
        items.reduce((sum, item) => sum + getActiveMs(item, nowTs), 0) / 1000
      );
      const completion = totalOrders ? doneItems.length / totalOrders : 0;
      lastStats = {
        produced,
        totalOrders,
        waiting,
        paused,
        avgDurationSec,
        activeSec,
        completion,
        doneCount: doneItems.length,
      };
      updateInsightsDisplay();
    }

    function sortItems(list) {
      const copy = [...list];
      if (sortBy === "recent") copy.sort((a, b) => (b.startTime || 0) - (a.startTime || 0));
      else if (sortBy === "oldest") copy.sort((a, b) => (a.startTime || 0) - (b.startTime || 0));
      else if (sortBy === "qty") copy.sort((a, b) => (b.qty || 0) - (a.qty || 0));
      else if (sortBy === "client")
        copy.sort((a, b) => a.client.localeCompare(b.client, "fr", { sensitivity: "base" }));
      else if (sortBy === "status") {
        const order = { wait: 0, pause: 1, done: 2 };
        copy.sort((a, b) => order[a.status] - order[b.status]);
      }
      return copy;
    }

    function render() {
      items.forEach(enrichItemState);
      computeStats();
      const list = listEl;

      // stop previous live timer (global unique)
      if (liveTimer) {
        clearInterval(liveTimer);
        liveTimer = null;
      }

      // filter + search
      const filtered = items.filter((i) => {
        if (filter !== "all" && i.status !== filter) return false;
        if (!search) return true;
        const s = (
          i.client +
          " " +
          i.name +
          " " +
          i.diam +
          " " +
          i.finish +
          " " +
          i.type +
          " " +
          i.carton
        ).toLowerCase();
        return s.includes(search);
      });

      const nowTs = now();
      const show = sortItems(filtered);

      list.innerHTML = show
        .map((i) => {
          const isWait = i.status === "wait";
          const liveSec = getEffectiveSeconds(i, nowTs);
          const longAwait = isWait && nowTs - (i.startTime || nowTs) > 3600 * 1000;
          const cls = longAwait ? "card awaiting-long" : "card";
          return `
          <div class="${cls}" data-id="${i.id}">
            <div class="row">
              <div class="handle" title="D√©placer">‚â°</div>
              <div class="title"><span>${escapeHtml(i.name)}</span></div>
              <span class="badge" data-s="${i.status}">${statusLabel(i.status)}</span>
            </div>
            <div class="meta">
              <span>Client : <b>${escapeHtml(i.client)}</b></span>
              <span>Qt√© : <b>${i.qty}</b></span>
              <span>${i.diam}</span><span>${i.finish}</span><span>${i.type}</span><span>${i.carton}</span>
            </div>
            <div class="meta">
              <span>Cr√©√© : ${fmtDate(i.startTime)}</span>
              ${
                i.status === "done"
                  ? `<span>Dur√©e effective : <b>${fmtDur(i.durationSec || liveSec)}</b></span><span>Termin√© : ${fmtDate(
                      i.endTime
                    )}</span>`
                  : i.status === "pause"
                  ? `<span>En pause : <b>${fmtDur(liveSec)}</b></span><span>Dernier arr√™t : ${fmtDate(
                      i.endTime
                    )}</span>`
                  : `<span>En cours : <b data-role="timer">${fmtDur(liveSec)}</b></span>`
              }
            </div>
            ${i.note ? `<div class="note">üìù ${escapeHtml(i.note)}</div>` : ""}
            <div class="actions">
              <button class="btn" data-a="edit">√âditer</button>
              <button class="btn" data-a="pause">${i.status === "pause" ? "Reprendre" : "Pause"}</button>
              <button class="btn" data-a="done">${i.status === "done" ? "Reprendre" : "Terminer"}</button>
              <button class="btn" data-a="del">Supprimer</button>
            </div>
          </div>
        `;
        })
        .join("");

      const hasItems = show.length > 0;
      if (emptyStateEl) emptyStateEl.hidden = hasItems;
      if (list) list.hidden = !hasItems;

      // anim carte √† l'ajout
      if (cardInAnimationNextRender && list.firstElementChild) {
        list.firstElementChild.style.animation = "fade .25s ease";
        cardInAnimationNextRender = false;
      }

      // live timer uniquement pour "wait"
      liveTimer = setInterval(() => {
        const tick = now();
        document.querySelectorAll(".card").forEach((card) => {
          const id = card.dataset.id;
          const it = items.find((x) => x.id === id);
          if (!it || it.status !== "wait") return;
          const b = card.querySelector("[data-role='timer']");
          if (!b) return;
          const d = getEffectiveSeconds(it, tick);
          b.textContent = fmtDur(d);
        });
      }, 1000);

      ensureSortable();
    }


    function handleListClick(e) {
      const card = e.target.closest(".card");
      if (!card) return;
      const id = card.dataset.id;
      const ix = items.findIndex((x) => x.id === id);
      if (ix < 0) return;
      const act = e.target.closest("[data-a]")?.dataset.a;
      if (!act) return;

      if (act === "edit") {
        openSheet(items[ix]);
        vibrate();
        return;
      }

      if (act === "pause") {
        const ts = now();
        if (items[ix].status === "pause") {
          transitionStatus(items[ix], "wait", ts);
        } else {
          transitionStatus(items[ix], "pause", ts);
        }
        save();
        render();
        vibrate();
        return;
      }

      if (act === "done") {
        const ts = now();
        if (items[ix].status !== "done") {
          transitionStatus(items[ix], "done", ts);
          confettiBurst();
        } else {
          transitionStatus(items[ix], "wait", ts);
        }
        save();
        render();
        vibrate();
        return;
      }

      if (act === "del") {
        const item = items[ix];
        requestDeletion(
          item,
          () => {
            card.style.transform = "translateX(-110%)";
            card.style.opacity = ".0";
            setTimeout(() => {
              items.splice(ix, 1);
              save();
              render();
            }, 200);
            vibrate(35);
          },
          () => resetSwipeStyles(card)
        );
        return;
      }
    }

    function ensureSortable() {
      if (sortableInstance || !listEl || typeof Sortable === "undefined") return;
      sortableInstance = new Sortable(listEl, {
        handle: ".handle",
        animation: 160,
        onEnd: handleSortEnd,
      });

    }

    function handleSortEnd() {
      const cards = Array.from(listEl.querySelectorAll(".card"));
      const visibleIds = cards.map((c) => c.dataset.id);
      const map = new Map(visibleIds.map((id, i) => [id, i]));
      items = items
        .slice()
        .sort((a, b) => {
          const ia = map.has(a.id) ? map.get(a.id) + 0.1 : 9999 + items.indexOf(a);
          const ib = map.has(b.id) ? map.get(b.id) + 0.1 : 9999 + items.indexOf(b);
          return ia - ib;
        });
      save();
      render();
      vibrate();
    }

    function resetSwipeStyles(card) {
      if (!card) return;
      card.style.transform = "";
      card.style.opacity = "";
    }

    function requestDeletion(item, onConfirm, onCancel) {
      const label = item?.name ? `¬´ ${item.name} ¬ª` : "cette commande";
      const confirmed = confirm(`Supprimer ${label} ?`);
      if (confirmed) {
        onConfirm?.();
      } else {
        onCancel?.();
      }
      return confirmed;
    }

    function onTouchStart(e) {
      const card = e.target.closest(".card");
      if (!card) return;
      swipeCard = card;
      swipeStartX = e.touches[0]?.clientX || 0;
      swipeStartY = e.touches[0]?.clientY || 0;
      swipeIsHorizontal = false;
      swipeMoving = true;
      card.style.transition = "";
    }

    function onTouchMove(e) {
      if (!swipeMoving || !swipeCard) return;
      const touch = e.touches[0];
      const touchX = touch?.clientX;
      const touchY = touch?.clientY;
      if (typeof touchX !== "number" || typeof touchY !== "number") return;
      const dx = touchX - swipeStartX;
      const dy = touchY - swipeStartY;
      if (Math.abs(dx) > 6) onPressEnd();

      const verticalDominant = Math.abs(dy) > 10 && Math.abs(dy) >= Math.abs(dx);
      if (verticalDominant) {
        swipeIsHorizontal = false;
        resetSwipeStyles(swipeCard);
        return;
      }

      if (!swipeIsHorizontal) {
        if (Math.abs(dx) > 10 && Math.abs(dx) >= Math.abs(dy)) {
          swipeIsHorizontal = true;
        } else {
          return;
        }
      }

      if (dx > -10) return;
      swipeCard.style.transform = `translateX(${dx}px)`;
      swipeCard.style.opacity = String(1 - Math.min(1, Math.abs(dx) / 180));
    }

    function onTouchEnd(e) {
      if (!swipeCard) return;
      const card = swipeCard;
      const touchX = e.changedTouches[0]?.clientX;
      const dx = (touchX ?? swipeStartX) - swipeStartX;
      swipeMoving = false;
      const wasHorizontal = swipeIsHorizontal;
      swipeIsHorizontal = false;
      swipeCard = null;
      card.style.transition = ".18s";
      if (wasHorizontal && dx < -90) {
        const id = card.dataset.id;
        const item = items.find((it) => it.id === id);
        const confirmed =
          item &&
          requestDeletion(
            item,
            () => {
              items = items.filter((it) => it.id !== id);
              save();
              render();
              vibrate(35);
            },
            () => resetSwipeStyles(card)
          );
        if (confirmed) {
          onPressEnd();
          return;
        }
      }
      resetSwipeStyles(card);
      onPressEnd();
    }

    function onTouchCancel() {
      if (!swipeCard) return;
      swipeCard.style.transition = ".18s";
      resetSwipeStyles(swipeCard);
      swipeMoving = false;
      swipeIsHorizontal = false;
      swipeCard = null;
      onPressEnd();
    }

    // long-press logic
    let pressTimer = null;
    function onPressStart(e) {
      const card = e.target.closest(".card");
      if (!card) return;
      const id = card.dataset.id;
      const item = items.find((x) => x.id === id);
      if (!item) return;
      pressTimer = setTimeout(() => {
        openSheet(item);
        vibrate();
      }, 600);
    }
    function onPressEnd() {
      clearTimeout(pressTimer);
      pressTimer = null;
    }

    if (listEl) {
      listEl.addEventListener("click", handleListClick);
      listEl.addEventListener("pointerdown", onPressStart);
      listEl.addEventListener("pointerup", onPressEnd);
      listEl.addEventListener("pointercancel", onPressEnd);
      listEl.addEventListener("touchstart", onTouchStart, { passive: true });
      listEl.addEventListener("touchmove", onTouchMove, { passive: true });
      listEl.addEventListener("touchend", onTouchEnd);
      listEl.addEventListener("touchcancel", onTouchCancel);
    }

    /* ====== Exports ====== */
    $("#exportCsv").onclick = () => {
      if (!items.length) return;
      const rows = items.map(({ id, ...c }) => ({
        client: c.client,
        name: c.name,
        qty: c.qty,
        diam: c.diam,
        finish: c.finish,
        type: c.type,
        carton: c.carton,
        status: c.status,
        startTime: c.startTime,
        endTime: c.endTime || "",
        durationSec: c.durationSec || 0,
        note: c.note || "",
      }));
      const header = Object.keys(rows[0]).join(";");
      const body = rows
        .map((r) =>
          Object.values(r)
            .map((v) => `"${String(v ?? "").replace(/"/g, '""')}"`)
            .join(";")
        )
        .join("\n");
      download(
        `badges_vmach_${dateStamp()}.csv`,
        header + "\n" + body,
        "text/csv;charset=utf-8"
      );
      vibrate();
    };

    $("#exportEmail").onclick = () => {
      const withDur = $("#optDur").checked;
      const done = items.filter((i) => i.status === "done");
      if (!done.length) {
        alert("Aucune commande termin√©e.");
        return;
      }
      const nowTs = now();
      const rows = done
        .map((i) => {
          const durSec = getEffectiveSeconds(i, nowTs);
          const durCell = withDur ? `<td>${fmtDur(durSec)}</td>` : "";
          return `
        <tr>
          <td>${escapeHtml(i.name)}</td>
          <td>${escapeHtml(i.client)}</td>
          <td style="text-align:right">${i.qty}</td>
          <td>${i.diam}</td><td>${i.finish}</td><td>${i.type}</td><td>${i.carton}</td>
          <td>${fmtDate(i.startTime)}</td><td>${fmtDate(i.endTime)}</td>
          ${durCell}
        </tr>`;
        })
        .join("");

      const headCols = `<th>Nom</th><th>Client</th><th>Qt√©</th><th>Format</th><th>Finition</th><th>Attache</th><th>Carton</th><th>Cr√©√©</th><th>Termin√©</th>${
        withDur ? "<th>Dur√©e</th>" : ""
      }`;
      const htmlTable = `
        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;font-family:Inter,Arial,sans-serif;font-size:14px">
          <thead style="background:#f2f5f9"><tr>${headCols}</tr></thead>
          <tbody>${rows}</tbody>
        </table>`;

      const totalQty = done.reduce((sum, i) => sum + (Number(i.qty) || 0), 0);
      const totalActiveSec = Math.floor(done.reduce((sum, i) => sum + getActiveMs(i, nowTs), 0) / 1000);
      const avgSec = done.length ? Math.round(totalActiveSec / done.length) : 0;
      const listLines = done
        .map((i, idx) => {
          const durSec = getEffectiveSeconds(i, nowTs);
          const durLabel = withDur && durSec ? ` ‚Ä¢ Dur√©e: ${fmtDur(durSec)}` : "";
          const endLabel = fmtDate(i.endTime);
          const endPart = endLabel !== "‚Äî" ? ` ‚Ä¢ Termin√©: ${endLabel}` : "";
          return `${idx + 1}. ${i.name} ‚Äî ${i.client}\n   Qt√©: ${i.qty} ‚Ä¢ Format: ${i.diam} ‚Ä¢ Finition: ${i.finish} ‚Ä¢ Attache: ${i.type} ‚Ä¢ Carton: ${i.carton}\n   Cr√©√©: ${fmtDate(i.startTime)}${endPart}${durLabel}`;
        })
        .join("\n\n");

      const summaryParts = [
        "Bonjour,",
        "",
        `Voici la synth√®se des badges termin√©s (${done.length} commande${done.length > 1 ? "s" : ""}).`,
        "",
        `Total badges : ${totalQty.toLocaleString("fr-FR")}`,
      ];
      if (withDur && totalActiveSec) {
        summaryParts.push(`Temps actif cumul√© : ${fmtDur(totalActiveSec)}`);
      }
      if (withDur && avgSec) {
        summaryParts.push(`Dur√©e moyenne : ${fmtDur(avgSec)}`);
      }
      if (listLines) {
        summaryParts.push("", listLines);
      }
      summaryParts.push(
        "",
        "Le tableau HTML d√©taill√© est copi√© dans votre presse-papiers pour un collage rapide.",
        "",
        "‚Äî",
        "V‚ÄëMACH Production Badges"
      );
      const plainBody = summaryParts.filter(Boolean).join("\n");
      const d = new Date();
      const subject = encodeURIComponent(
        `Synth√®se badges V‚ÄëMACH termin√©s ‚Äì ${d.toLocaleDateString("fr-FR")}`
      );
      const body = encodeURIComponent(plainBody);

      const afterCopy = () => {
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      };
      copyToClipboard(htmlTable).then(afterCopy).catch(afterCopy);
      vibrate();
    };

    function copyToClipboard(html) {
      if (navigator.clipboard && navigator.clipboard.write) {
        const blob = new Blob([html], { type: "text/html" });
        const item = new ClipboardItem({ "text/html": blob });
        return navigator.clipboard.write([item]).catch(() => {
          return navigator.clipboard.writeText(html);
        });
      }
      return navigator.clipboard?.writeText(html) || Promise.resolve();
    }

    function download(name, content, type) {
      const blob = new Blob([content], { type });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function dateStamp() {
      const d = new Date();
      const p = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())}_${p(
        d.getHours()
      )}${p(d.getMinutes())}`;
    }

    /* ====== Confetti (minimal) ====== */
    function confettiBurst() {
      const c = $("#confetti");
      const w = window.innerWidth,
        h = window.innerHeight;
      c.width = w;
      c.height = h;
      c.hidden = false;
      const ctx = c.getContext("2d");
      const parts = [...Array(42)].map(() => ({
        x: w / 2,
        y: 80,
        vx: (Math.random() - 0.5) * 6,
        vy: Math.random() * -4 - 2,
        g: 0.18,
        s: Math.random() * 3 + 2,
        a: 1,
        col: Math.random() > 0.5 ? "#fff" : Math.random() > 0.5 ? "#ffd166" : "#8efadb",
      }));
      let t = 0;
      function step() {
        ctx.clearRect(0, 0, w, h);
        parts.forEach((p) => {
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.a -= 0.01;
          ctx.globalAlpha = Math.max(0, p.a);
          ctx.fillStyle = p.col;
          ctx.fillRect(p.x, p.y, p.s, p.s);
        });
        if (++t < 120) requestAnimationFrame(step);
        else {
          c.hidden = true;
          ctx.clearRect(0, 0, w, h);
        }
      }
      step();
      setTimeout(() => {
        c.hidden = true;
      }, 1800);
    }

    /* ====== Storage sync & Init ====== */
    initPersistentState();

    window.addEventListener("storage", () => {
      items = load().map(enrichItemState);
      saveToIndexedDB(items);
      render();
    });
    render();

    /* ====== PWA: register SW ====== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .then(() => console.log("Service Worker enregistr√© ‚úÖ"))
          .catch(console.error);
      });
    }

    /* ====== Self-tests (console) ====== */
    console.assert(fmtDur(0) === "‚Äî" && fmtDur(61).includes("1m"), "fmtDur");
    console.assert(
      statusLabel("wait") === "En attente" && statusLabel("done") === "Termin√©e",
      "statusLabel"
    );
  </script>
</body>
</html>
